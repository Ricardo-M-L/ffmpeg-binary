<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>视频上传转换测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .container {
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 8px;
    }
    input[type="file"] {
      margin: 10px 0;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
    }
    .progress {
      margin: 20px 0;
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #4CAF50;
      width: 0%;
      transition: width 0.3s;
    }
    .log {
      background: #f5f5f5;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>视频上传转换测试</h1>
    
    <div>
      <input type="file" id="fileInput" accept="video/webm,video/mp4">
      <button onclick="startUpload()">开始上传</button>
    </div>

    <div class="progress" id="progressContainer" style="display:none;">
      <p id="status">准备中...</p>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <p id="progressText">0%</p>
    </div>

    <div class="log" id="log"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000/api';
    let currentUploadId = null;
    let currentTaskId = null;

    function log(message) {
      const logEl = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      logEl.innerHTML += `[${time}] ${message}<br>`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(message);
    }

    function updateProgress(percent, status) {
      document.getElementById('progressContainer').style.display = 'block';
      document.getElementById('progressFill').style.width = percent + '%';
      document.getElementById('progressText').textContent = percent + '%';
      document.getElementById('status').textContent = status;
    }

    async function startUpload() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('请选择文件');
        return;
      }

      log(`开始上传文件: ${file.name}, 大小: ${(file.size / 1024 / 1024).toFixed(2)}MB`);
      
      try {
        // 1. 初始化上传
        const chunkSize = 1024 * 1024; // 1MB per chunk
        const totalChunks = Math.ceil(file.size / chunkSize);
        
        log(`文件将被分为 ${totalChunks} 个切片`);
        updateProgress(0, '初始化上传...');

        const initRes = await fetch(`${API_BASE}/upload/init`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            fileName: file.name,
            fileSize: file.size,
            totalChunks,
            chunkSize
          })
        });

        const initData = await initRes.json();
        if (!initData.success) {
          throw new Error('初始化失败: ' + initData.message);
        }

        currentUploadId = initData.data.uploadId;
        log(`上传任务已初始化: ${currentUploadId}`);

        // 2. 上传切片
        for (let i = 0; i < totalChunks; i++) {
          const start = i * chunkSize;
          const end = Math.min(start + chunkSize, file.size);
          const chunk = file.slice(start, end);

          const formData = new FormData();
          formData.append('file', chunk);
          formData.append('uploadId', currentUploadId);
          formData.append('chunkIndex', i);

          const chunkRes = await fetch(`${API_BASE}/upload/chunk`, {
            method: 'POST',
            body: formData
          });

          const chunkData = await chunkRes.json();
          if (!chunkData.success) {
            throw new Error(`切片 ${i} 上传失败: ` + chunkData.message);
          }

          const progress = Math.round((i + 1) / totalChunks * 50); // 上传占50%
          updateProgress(progress, `上传切片 ${i + 1}/${totalChunks}`);
          log(`切片 ${i + 1}/${totalChunks} 上传完成`);
        }

        log('所有切片上传完成，等待合并...');
        updateProgress(50, '等待文件合并...');

        // 3. 等待合并完成
        await waitForMerge(currentUploadId);

        // 4. 开始转换
        log('开始视频格式转换...');
        updateProgress(60, '开始转换...');

        const convertRes = await fetch(`${API_BASE}/convert/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            uploadId: currentUploadId,
            outputFormat: 'mp4',
            quality: 'medium'
          })
        });

        const convertData = await convertRes.json();
        if (!convertData.success) {
          throw new Error('启动转换失败: ' + convertData.message);
        }

        currentTaskId = convertData.data.taskId;
        log(`转换任务已启动: ${currentTaskId}`);

        // 5. 轮询转换进度
        await pollConversionProgress(currentTaskId);

      } catch (error) {
        log(`❌ 错误: ${error.message}`);
        updateProgress(0, '失败: ' + error.message);
      }
    }

    async function waitForMerge(uploadId) {
      return new Promise((resolve, reject) => {
        const checkInterval = setInterval(async () => {
          try {
            const res = await fetch(`${API_BASE}/upload/status/${uploadId}`);
            const data = await res.json();
            
            if (data.success && data.data.status === 'merged') {
              clearInterval(checkInterval);
              log('文件合并完成');
              resolve();
            } else if (data.data.status === 'failed') {
              clearInterval(checkInterval);
              reject(new Error('文件合并失败'));
            }
          } catch (error) {
            clearInterval(checkInterval);
            reject(error);
          }
        }, 1000);

        // 超时保护
        setTimeout(() => {
          clearInterval(checkInterval);
          reject(new Error('合并超时'));
        }, 60000);
      });
    }

    async function pollConversionProgress(taskId) {
      return new Promise((resolve, reject) => {
        const checkInterval = setInterval(async () => {
          try {
            const res = await fetch(`${API_BASE}/progress/${taskId}`);
            const data = await res.json();
            
            if (!data.success) {
              clearInterval(checkInterval);
              reject(new Error('查询进度失败'));
              return;
            }

            const progress = data.data.progress;
            const status = data.data.status;
            
            // 转换进度占40%（60%-100%）
            const totalProgress = 60 + Math.round(progress * 0.4);
            updateProgress(totalProgress, `转换中: ${progress}%`);
            log(`转换进度: ${progress}%`);

            if (status === 'completed') {
              clearInterval(checkInterval);
              updateProgress(100, '转换完成！');
              log(`✅ 转换完成！输出文件: ${data.data.outputPath}`);
              log(`下载地址: http://localhost:3000/downloads/${taskId.split('/').pop()}`);
              resolve(data.data);
            } else if (status === 'failed') {
              clearInterval(checkInterval);
              reject(new Error('转换失败: ' + (data.data.error || '未知错误')));
            }
          } catch (error) {
            clearInterval(checkInterval);
            reject(error);
          }
        }, 1000);

        // 超时保护（10分钟）
        setTimeout(() => {
          clearInterval(checkInterval);
          reject(new Error('转换超时'));
        }, 600000);
      });
    }
  </script>
</body>
</html>


