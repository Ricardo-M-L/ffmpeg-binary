<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFmpeg Video Converter - ç¤ºä¾‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 32px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-area.dragging {
            border-color: #667eea;
            background: #f0f2ff;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress {
            margin-top: 20px;
            display: none;
        }

        .progress.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .status {
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .result {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 12px;
            display: none;
        }

        .result.active {
            display: block;
        }

        video {
            width: 100%;
            border-radius: 8px;
            margin-top: 15px;
        }

        .info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ FFmpeg è§†é¢‘è½¬æ¢å™¨</h1>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('sync')">åŒæ­¥è½¬æ¢</button>
            <button class="tab" onclick="switchTab('async')">å¼‚æ­¥è½¬æ¢</button>
        </div>

        <!-- åŒæ­¥è½¬æ¢ -->
        <div id="sync" class="tab-content active">
            <div class="upload-area" id="syncUpload" onclick="document.getElementById('syncFile').click()">
                <p style="font-size: 48px; margin-bottom: 10px;">ğŸ“</p>
                <p style="font-size: 18px; color: #333;">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  WebM è§†é¢‘</p>
                <p style="font-size: 14px; color: #999; margin-top: 10px;">æ”¯æŒç›´æ¥è½¬æ¢ä¸º MP4</p>
            </div>
            <input type="file" id="syncFile" accept="video/webm">

            <div class="progress" id="syncProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="syncProgressFill" style="width: 0%"></div>
                </div>
                <div class="status" id="syncStatus">å‡†å¤‡è½¬æ¢...</div>
            </div>

            <div class="result" id="syncResult">
                <h3>âœ… è½¬æ¢å®Œæˆ!</h3>
                <video id="syncVideo" controls></video>
                <button class="btn btn-primary" onclick="downloadVideo('syncVideo')">ä¸‹è½½ MP4</button>
            </div>
        </div>

        <!-- å¼‚æ­¥è½¬æ¢ -->
        <div id="async" class="tab-content">
            <div class="upload-area" id="asyncUpload" onclick="document.getElementById('asyncFile').click()">
                <p style="font-size: 48px; margin-bottom: 10px;">ğŸ“</p>
                <p style="font-size: 18px; color: #333;">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  WebM è§†é¢‘</p>
                <p style="font-size: 14px; color: #999; margin-top: 10px;">åˆ†ç‰‡ä¸Šä¼ ,é€‚åˆå¤§æ–‡ä»¶</p>
            </div>
            <input type="file" id="asyncFile" accept="video/webm">

            <div class="progress" id="asyncProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="asyncProgressFill" style="width: 0%"></div>
                </div>
                <div class="status" id="asyncStatus">å‡†å¤‡ä¸Šä¼ ...</div>
            </div>

            <div class="result" id="asyncResult">
                <h3>âœ… è½¬æ¢å®Œæˆ!</h3>
                <video id="asyncVideo" controls></video>
                <button class="btn btn-primary" onclick="downloadVideo('asyncVideo')">ä¸‹è½½ MP4</button>
            </div>
        </div>

        <div class="info">
            ğŸ’¡ <strong>æç¤º:</strong> ç¡®ä¿ FFmpeg Binary æœåŠ¡æ­£åœ¨è¿è¡Œ (ç«¯å£ 18888)
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:18888/api/v1';

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        // åŒæ­¥è½¬æ¢
        document.getElementById('syncFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const progress = document.getElementById('syncProgress');
            const progressFill = document.getElementById('syncProgressFill');
            const status = document.getElementById('syncStatus');
            const result = document.getElementById('syncResult');

            progress.classList.add('active');
            result.classList.remove('active');
            status.textContent = 'æ­£åœ¨è½¬æ¢...';
            progressFill.style.width = '50%';

            try {
                const response = await fetch(`${API_BASE}/convert/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'video/webm' },
                    body: file
                });

                if (!response.ok) throw new Error('è½¬æ¢å¤±è´¥');

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);

                document.getElementById('syncVideo').src = url;
                progressFill.style.width = '100%';
                status.textContent = 'è½¬æ¢å®Œæˆ!';

                setTimeout(() => {
                    progress.classList.remove('active');
                    result.classList.add('active');
                }, 500);
            } catch (error) {
                status.textContent = 'è½¬æ¢å¤±è´¥: ' + error.message;
                progressFill.style.width = '0%';
            }
        });

        // å¼‚æ­¥è½¬æ¢
        document.getElementById('asyncFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const progress = document.getElementById('asyncProgress');
            const progressFill = document.getElementById('asyncProgressFill');
            const status = document.getElementById('asyncStatus');
            const result = document.getElementById('asyncResult');

            progress.classList.add('active');
            result.classList.remove('active');

            try {
                // åˆ›å»ºä»»åŠ¡
                status.textContent = 'åˆ›å»ºè½¬æ¢ä»»åŠ¡...';
                const createResp = await fetch(`${API_BASE}/convert/async`, { method: 'POST' });
                const { task_id, upload_url } = await createResp.json();

                // åˆ†ç‰‡ä¸Šä¼ 
                const chunkSize = 1024 * 1024; // 1MB
                const totalChunks = Math.ceil(file.size / chunkSize);

                for (let i = 0; i < totalChunks; i++) {
                    const start = i * chunkSize;
                    const end = Math.min(start + chunkSize, file.size);
                    const chunk = file.slice(start, end);
                    const isLast = i === totalChunks - 1;

                    await fetch(`${API_BASE}${upload_url}`, {
                        method: 'POST',
                        headers: { 'X-Last-Chunk': isLast ? 'true' : 'false' },
                        body: chunk
                    });

                    const uploadProgress = Math.floor((i + 1) / totalChunks * 50);
                    progressFill.style.width = uploadProgress + '%';
                    status.textContent = `ä¸Šä¼ ä¸­... ${i + 1}/${totalChunks}`;
                }

                // è½®è¯¢çŠ¶æ€
                status.textContent = 'æ­£åœ¨è½¬æ¢...';
                while (true) {
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    const statusResp = await fetch(`${API_BASE}/task/${task_id}`);
                    const taskStatus = await statusResp.json();

                    const totalProgress = 50 + Math.floor(taskStatus.progress / 2);
                    progressFill.style.width = totalProgress + '%';
                    status.textContent = `è½¬æ¢ä¸­... ${taskStatus.progress}%`;

                    if (taskStatus.status === 'completed') {
                        // ä¸‹è½½è§†é¢‘
                        const downloadResp = await fetch(`${API_BASE}/task/${task_id}/download`);
                        const blob = await downloadResp.blob();
                        const url = URL.createObjectURL(blob);

                        document.getElementById('asyncVideo').src = url;
                        progressFill.style.width = '100%';
                        status.textContent = 'è½¬æ¢å®Œæˆ!';

                        setTimeout(() => {
                            progress.classList.remove('active');
                            result.classList.add('active');
                        }, 500);
                        break;
                    } else if (taskStatus.status === 'failed') {
                        throw new Error(taskStatus.error);
                    }
                }
            } catch (error) {
                status.textContent = 'è½¬æ¢å¤±è´¥: ' + error.message;
                progressFill.style.width = '0%';
            }
        });

        // ä¸‹è½½è§†é¢‘
        function downloadVideo(videoId) {
            const video = document.getElementById(videoId);
            const a = document.createElement('a');
            a.href = video.src;
            a.download = 'converted_' + Date.now() + '.mp4';
            a.click();
        }

        // æ‹–æ‹½ä¸Šä¼ æ”¯æŒ
        ['syncUpload', 'asyncUpload'].forEach(id => {
            const area = document.getElementById(id);
            const fileInput = document.getElementById(id.replace('Upload', 'File'));

            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragging');
            });

            area.addEventListener('dragleave', () => {
                area.classList.remove('dragging');
            });

            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragging');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    fileInput.dispatchEvent(new Event('change'));
                }
            });
        });
    </script>
</body>
</html>